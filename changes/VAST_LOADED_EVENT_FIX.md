# Исправление преждевременного срабатывания события vast-loaded

## Проблема

Событие `vast-loaded` срабатывало преждевременно - сразу при инициализации плагина, а не после фактической загрузки VAST кода с сервера. Это приводило к неточной аналитике и ложному ощущению готовности VAST данных.

### Симптомы:
- Событие `vast-loaded` срабатывало при создании экземпляра плагина
- HTTP-запрос к VAST серверу еще висел в состоянии "Pending" в инспекторе браузера
- Плагин продолжал выполнение до фактической загрузки данных

## Анализ проблемы

### До исправления:
```javascript
// vast-plugin.mjs (конструктор)
const vastUrl = options.url || 'inline-xml';
Logger.logVastLoaded(vastUrl);  // ← Событие срабатывало ЗДЕСЬ

// Позже в том же конструкторе
adLoader.loadAds(preRollScheduleItem)  // ← Фактическая загрузка ЗДЕСЬ
```

### Последовательность событий была неправильной:
1. ❌ `vast-loaded` - при инициализации плагина (неправильно)
2. ✅ `vast-parsed` - после получения ответа от сервера
3. ✅ `vast-ready` - после создания TrackedAd объектов

## Решение

Перемещено логирование события `vast-loaded` из конструктора плагина в `AdLoader` после успешного завершения HTTP-запроса.

### Изменения в файлах:

#### 1. `src/vast-plugin.mjs`
**Удалено:**
```javascript
// Логируем событие загрузки VAST плагина
const vastUrl = options.url || 'inline-xml';
Logger.logVastLoaded(vastUrl);
```

#### 2. `src/ad-loader.mjs`

**Добавлено в `loadAdsWithUrl()`:**
```javascript
.then(ads => {
  // Логируем событие успешной загрузки VAST
  Logger.logVastLoaded(url);
  // Логируем событие парсинга VAST
  Logger.logVastParsed(url);
  return this.#adSelector.selectAds(ads);
})
```

**Добавлено в `loadAdsWithXml()`:**
```javascript
.then(ads => {
  // Логируем событие успешной загрузки VAST (для inline XML)
  Logger.logVastLoaded('inline-xml');
  // Логируем событие парсинга VAST
  Logger.logVastParsed('inline-xml');
  return this.#adSelector.selectAds(ads);
})
```

## Результат

### Правильная последовательность событий:
1. ✅ `vast-loaded` - после успешного завершения HTTP-запроса
2. ✅ `vast-parsed` - после парсинга полученных данных
3. ✅ `vast-ready` - после создания TrackedAd объектов

### Преимущества:
- **Точная аналитика** - событие отражает реальное время завершения загрузки
- **Корректный мониторинг** - можно точно определить момент успешной загрузки VAST
- **Правильная логика** - плагин продолжает выполнение только после фактической загрузки данных

## Технические детали

### Логирование для URL-based VAST:
- Событие `vast-loaded` срабатывает в `.then()` после успешного `vastClient.get()`
- URL передается в событие для трассировки

### Логирование для inline XML:
- Событие `vast-loaded` срабатывает в `.then()` после успешного `vastParser.parseVAST()`
- Используется строка `'inline-xml'` в качестве идентификатора

### Обработка ошибок:
- Если HTTP-запрос завершается с ошибкой, событие `vast-loaded` не срабатывает
- Это соответствует логике - VAST не был загружен, если запрос провалился

## Совместимость

- ✅ Обратная совместимость сохранена
- ✅ Существующий код продолжит работать без изменений
- ✅ Изменилась только последовательность и точность событий
- ✅ Формат событий остался прежним

## Тестирование

Для проверки исправления:
1. Откройте консоль браузера
2. Инициализируйте VAST плагин с URL
3. Проверьте, что событие `vast-loaded` срабатывает **после** завершения HTTP-запроса в Network tab
4. Убедитесь, что последовательность событий: `vast-loaded` → `vast-parsed` → `vast-ready`
